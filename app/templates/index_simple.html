{% extends "base_simple.html" %}

{% block title %}Dashboard - Data Integration Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </h1>
    </div>
</div>

<!-- Welcome Message -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h4><i class="fas fa-rocket"></i> Welcome to Your Data Integration Platform!</h4>
            <p class="mb-0">ðŸŽ¯ Upload your API documents or Postman collections to get started with AI-powered data integration.</p>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Sources</h5>
                        <h2 id="sources-count">-</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Destinations</h5>
                        <h2 id="destinations-count">-</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-cloud-upload-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Mappings</h5>
                        <h2 id="mappings-count">-</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-map fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">AI Features</h5>
                        <h2><i class="fas fa-brain"></i></h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-robot fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('sources') }}" class="btn btn-outline-primary btn-lg w-100">
                            <i class="fas fa-plus"></i><br>
                            Add Source
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('destinations') }}" class="btn btn-outline-success btn-lg w-100">
                            <i class="fas fa-plus"></i><br>
                            Add Destination
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('create_mapping') }}" class="btn btn-outline-info btn-lg w-100">
                            <i class="fas fa-map"></i><br>
                            Create Mapping
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-warning btn-lg w-100" data-bs-toggle="modal" data-bs-target="#apiDocsModal">
                            <i class="fas fa-file-upload"></i><br>
                            Upload Docs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Features -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-brain"></i> AI-Powered Features
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Smart field mapping suggestions
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        API documentation analysis
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Postman collection import
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Data validation recommendations
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> System Info
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Status</span>
                        <span class="badge bg-success">Running</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>AI Integration</span>
                        <span class="badge bg-primary">Gemini AI</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Version</span>
                        <span>v1.0.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Documentation Upload Modal -->
<div class="modal fade" id="apiDocsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload API Documentation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="docFile" class="form-label">Select Documentation File</label>
                    <input type="file" class="form-control" id="docFile" accept=".json,.yaml,.yml,.md,.txt">
                    <div class="form-text">Supported formats: JSON (Postman Collections), YAML, Markdown, Text</div>
                </div>
                <div class="mb-3">
                    <label for="docContent" class="form-label">Or paste content directly:</label>
                    <textarea class="form-control" id="docContent" rows="10" placeholder="Paste your Postman collection, API documentation, or any relevant documentation here..."></textarea>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="analyzeDocBtn">
                        <i class="fas fa-robot"></i> Analyze Documentation
                    </button>
                    <button type="button" class="btn btn-info" id="analyzePostmanBtn" style="display: none;">
                        <i class="fas fa-rocket"></i> Analyze Postman Collection
                    </button>
                    <button type="button" class="btn btn-success" id="createFromAnalysisBtn" style="display: none;">
                        <i class="fas fa-magic"></i> Create Sources & Destinations
                    </button>
                </div>
                <div id="analysisResult" class="mt-3" style="display: none;">
                    <!-- Analysis results will appear here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    loadDashboardData();
    
    // File upload handler
    $('#docFile').change(function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                $('#docContent').val(content);
                
                // Check if it's a Postman collection
                try {
                    const jsonData = JSON.parse(content);
                    if (jsonData.info && jsonData.item) {
                        $('#analyzePostmanBtn').show();
                        $('#analyzeDocBtn').text('Analyze as Documentation');
                    }
                } catch (e) {
                    $('#analyzePostmanBtn').hide();
                    $('#analyzeDocBtn').text('Analyze with AI');
                }
            };
            reader.readAsText(file);
        }
    });
    
    // Check content on typing
    $('#docContent').on('input', function() {
        const content = $(this).val();
        try {
            const jsonData = JSON.parse(content);
            if (jsonData.info && jsonData.item) {
                $('#analyzePostmanBtn').show();
                $('#analyzeDocBtn').text('Analyze as Documentation');
            } else {
                $('#analyzePostmanBtn').hide();
                $('#analyzeDocBtn').text('Analyze with AI');
            }
        } catch (e) {
            $('#analyzePostmanBtn').hide();
            $('#analyzeDocBtn').text('Analyze with AI');
        }
    });
    
    // Analyze as Postman collection
    $('#analyzePostmanBtn').click(function() {
        const content = $('#docContent').val();
        if (!content.trim()) {
            alert('Please provide Postman collection content');
            return;
        }
        
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Analyzing Postman Collection...');
        
        $.ajax({
            url: '/api/ai/analyze-postman',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({content: content}),
            success: function(data) {
                if (data.success) {
                    displayPostmanAnalysis(data);
                    $('#createFromAnalysisBtn').show().data('analysis', data);
                } else {
                    $('#analysisResult').html(`
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> Analysis Failed</h6>
                            <p>${data.error}</p>
                        </div>
                    `).show();
                }
            },
            error: function() {
                $('#analysisResult').html(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Request Failed</h6>
                        <p>Failed to connect to analysis service</p>
                    </div>
                `).show();
            },
            complete: function() {
                $('#analyzePostmanBtn').prop('disabled', false).html('<i class="fas fa-rocket"></i> Analyze Postman Collection');
            }
        });
    });
    
    // Analyze documentation
    $('#analyzeDocBtn').click(function() {
        const content = $('#docContent').val();
        if (!content.trim()) {
            alert('Please provide documentation content');
            return;
        }
        
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Analyzing...');
        
        $.ajax({
            url: '/api/ai/analyze-docs',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({content: content}),
            success: function(data) {
                if (data.success) {
                    $('#analysisResult').html(`
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check"></i> Analysis Complete!</h6>
                            <pre class="mt-2">${data.raw_content}</pre>
                        </div>
                    `).show();
                } else {
                    $('#analysisResult').html(`
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> Analysis Failed</h6>
                            <p>${data.error}</p>
                        </div>
                    `).show();
                }
            },
            error: function() {
                $('#analysisResult').html(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Request Failed</h6>
                        <p>Failed to connect to AI service</p>
                    </div>
                `).show();
            },
            complete: function() {
                $('#analyzeDocBtn').prop('disabled', false).html('<i class="fas fa-robot"></i> Analyze with AI');
            }
        });
    });
});

function setupToolSelectionHandlers() {
    // Store analysis data globally for access
    window.currentAnalysisData = arguments[0] || window.currentAnalysisData;
    
    // Show/hide create button based on selections
    $('.source-check, .destination-check').change(function() {
        const hasSelections = $('.source-check:checked, .destination-check:checked').length > 0;
        $('#createSelectedToolsBtn').toggle(hasSelections);
    });
    
    // Create sources and destinations from selected tools
    $('#createSelectedToolsBtn').click(function() {
        const selectedTools = {};
        
        // Collect selected tools
        $('.tool-group').each(function() {
            const toolName = $(this).data('tool');
            const sourceChecked = $(this).find('.source-check').is(':checked');
            const destChecked = $(this).find('.destination-check').is(':checked');
            
            if (sourceChecked || destChecked) {
                selectedTools[toolName] = {
                    selected: true,
                    as_source: sourceChecked,
                    as_destination: destChecked,
                    endpoints: window.currentAnalysisData?.tools_endpoints?.[toolName]?.endpoints || []
                };
            }
        });
        
        if (Object.keys(selectedTools).length === 0) {
            alert('Please select at least one tool as source or destination');
            return;
        }
        
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creating...');
        
        $.ajax({
            url: '/api/ai/create-from-tools',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({selected_tools: selectedTools}),
            success: function(response) {
                if (response.success) {
                    showAlert(`Successfully created ${response.created_sources} sources and ${response.created_destinations} destinations!`, 'success');
                    loadDashboardData(); // Refresh counts
                    
                    // Update the interface to show what was created
                    $('#analysisResult').append(`
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-check"></i> Integration Setup Complete!</h6>
                            <p>${response.message}</p>
                            <div class="mt-2">
                                <a href="/sources" class="btn btn-sm btn-primary me-2">
                                    <i class="fas fa-eye"></i> View Sources
                                </a>
                                <a href="/destinations" class="btn btn-sm btn-success me-2">
                                    <i class="fas fa-eye"></i> View Destinations
                                </a>
                                <a href="/mappings/create" class="btn btn-sm btn-info">
                                    <i class="fas fa-map"></i> Create Mappings
                                </a>
                            </div>
                        </div>
                    `);
                } else {
                    showAlert('Failed to create sources/destinations: ' + response.error, 'danger');
                }
            },
            error: function() {
                showAlert('Failed to create sources and destinations', 'danger');
            },
            complete: function() {
                $('#createSelectedToolsBtn').prop('disabled', false).html('<i class="fas fa-magic"></i> Create Selected Sources & Destinations');
            }
        });
    });
}

function displayPostmanAnalysis(data) {
    const collection = data.collection_info;
    const tools = data.tools_detected || [];
    const toolsEndpoints = data.tools_endpoints || {};
    const workflows = data.workflows || [];
    
    let html = `
        <div class="alert alert-success">
            <h5><i class="fas fa-check-circle"></i> Postman Collection Analysis Complete!</h5>
            
            <div class="row mt-3">
                <div class="col-md-8">
                    <h6><i class="fas fa-info-circle"></i> Collection Info</h6>
                    <ul class="list-unstyled">
                        <li><strong>Name:</strong> ${collection.name}</li>
                        <li><strong>Endpoints:</strong> ${collection.endpoint_count}</li>
                        <li><strong>Description:</strong> ${collection.description || 'No description'}</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6><i class="fas fa-tools"></i> Tools Detected</h6>
                    <div class="d-flex flex-wrap gap-1">
                        ${tools.map(tool => `<span class="badge bg-primary">${tool}</span>`).join('')}
                        ${tools.length === 0 ? '<span class="text-muted">No specific tools detected</span>' : ''}
                    </div>
                </div>
            </div>
            
            <!-- Grouped Tools Interface -->
            <div class="mt-4">
                <h6><i class="fas fa-layer-group"></i> API Groups - Select Sources & Destinations</h6>
                <div class="tools-selection">
    `;
    
    // Display tools grouped with selection interface
    Object.keys(toolsEndpoints).forEach(toolName => {
        const toolData = toolsEndpoints[toolName];
        const getCount = toolData.get_endpoints?.length || 0;
        const postCount = toolData.post_endpoints?.length || 0;
        const totalCount = toolData.endpoints?.length || 0;
        
        html += `
            <div class="card mb-3 tool-group" data-tool="${toolName}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="fas fa-cube"></i> ${toolName}
                            <span class="badge bg-secondary ms-2">${totalCount} endpoints</span>
                        </h6>
                    </div>
                    <div class="tool-actions">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input source-check" type="checkbox" 
                                   id="source_${toolName.replace(/\s+/g, '_')}" data-tool="${toolName}">
                            <label class="form-check-label" for="source_${toolName.replace(/\s+/g, '_')}">
                                <i class="fas fa-download text-primary"></i> Source (${getCount})
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input destination-check" type="checkbox" 
                                   id="dest_${toolName.replace(/\s+/g, '_')}" data-tool="${toolName}">
                            <label class="form-check-label" for="dest_${toolName.replace(/\s+/g, '_')}">
                                <i class="fas fa-upload text-success"></i> Destination (${postCount})
                            </label>
                        </div>
                    </div>
                </div>
                <div class="card-body collapse" id="collapse_${toolName.replace(/\s+/g, '_')}">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-download"></i> GET Endpoints (Sources)</h6>
                            <div class="endpoint-list">
                                ${toolData.get_endpoints?.map(ep => `
                                    <div class="border rounded p-2 mb-1 bg-light">
                                        <small><strong>${ep.name}</strong></small><br>
                                        <small class="text-muted">${ep.method} ${ep.path}</small>
                                    </div>
                                `).join('') || '<small class="text-muted">No GET endpoints</small>'}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success"><i class="fas fa-upload"></i> POST/PUT Endpoints (Destinations)</h6>
                            <div class="endpoint-list">
                                ${toolData.post_endpoints?.map(ep => `
                                    <div class="border rounded p-2 mb-1 bg-light">
                                        <small><strong>${ep.name}</strong></small><br>
                                        <small class="text-muted">${ep.method} ${ep.path}</small>
                                    </div>
                                `).join('') || '<small class="text-muted">No POST/PUT endpoints</small>'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <button class="btn btn-sm btn-outline-info toggle-details" 
                            data-bs-toggle="collapse" data-bs-target="#collapse_${toolName.replace(/\s+/g, '_')}">
                        <i class="fas fa-eye"></i> View Endpoints
                    </button>
                </div>
            </div>
        `;
    });
    
    html += `
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-success btn-lg" id="createSelectedToolsBtn" style="display: none;">
                        <i class="fas fa-magic"></i> Create Selected Sources & Destinations
                    </button>
                </div>
            </div>
            
            ${workflows.length > 0 ? `
            <div class="mt-3">
                <h6><i class="fas fa-sitemap"></i> Suggested Workflows</h6>
                <div class="workflows-list">
                    ${workflows.map(workflow => `
                        <div class="border rounded p-2 mb-2 bg-info bg-opacity-10">
                            <strong>${workflow.name}</strong><br>
                            <small>${workflow.description}</small><br>
                            <small class="text-muted">Confidence: ${workflow.confidence}</small>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${data.ai_analysis ? `
            <div class="mt-3">
                <h6><i class="fas fa-brain"></i> AI Analysis</h6>
                <div class="bg-light p-3 rounded">
                    <pre style="white-space: pre-wrap; font-size: 0.9em;">${data.ai_analysis}</pre>
                </div>
            </div>
            ` : ''}
        </div>
    `;
    
    $('#analysisResult').html(html).show();
    
    // Store data globally and setup handlers
    window.currentAnalysisData = data;
    setupToolSelectionHandlers(data);
}

// Create sources and destinations from analysis
$('#createFromAnalysisBtn').click(function() {
    const data = $(this).data('analysis');
    if (!data) return;
    
    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creating...');
    
    // Create sources
    const createPromises = [];
    
    data.suggested_sources.forEach(function(source) {
        const sourceData = {
            name: source.name,
            type: 'api',
            description: `${source.reason} - Auto-created from Postman collection`,
            config: {
                url: source.url,
                method: source.method,
                endpoint: source.endpoint,
                folder: source.folder || '',
                postman_generated: true
            }
        };
        
        createPromises.push(
            $.ajax({
                url: '/api/sources',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(sourceData)
            })
        );
    });
    
    // Create destinations
    data.suggested_destinations.forEach(function(dest) {
        const destData = {
            name: dest.name,
            type: 'api',
            description: `${dest.reason} - Auto-created from Postman collection`,
            config: {
                url: dest.url,
                method: dest.method,
                endpoint: dest.endpoint,
                folder: dest.folder || '',
                postman_generated: true
            }
        };
        
        createPromises.push(
            $.ajax({
                url: '/api/destinations',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(destData)
            })
        );
    });
    
    Promise.all(createPromises).then(function(results) {
        const successful = results.filter(r => r.success).length;
        const total = results.length;
        
        showAlert(`Successfully created ${successful}/${total} sources and destinations from your Postman collection!`, 'success');
        loadDashboardData(); // Refresh counts
        
        $('#createFromAnalysisBtn').prop('disabled', false).html('<i class="fas fa-magic"></i> Create Sources & Destinations');
    }).catch(function() {
        showAlert('Some items could not be created. Check the console for details.', 'warning');
        $('#createFromAnalysisBtn').prop('disabled', false).html('<i class="fas fa-magic"></i> Create Sources & Destinations');
    });
});

function loadDashboardData() {
    // Load counts
    $.get('/api/sources', function(data) {
        if (data.success) {
            $('#sources-count').text(data.data.length);
        }
    });
    
    $.get('/api/destinations', function(data) {
        if (data.success) {
            $('#destinations-count').text(data.data.length);
        }
    });
    
    $.get('/api/mappings', function(data) {
        if (data.success) {
            $('#mappings-count').text(data.data.length);
        }
    });
}
</script>
{% endblock %}