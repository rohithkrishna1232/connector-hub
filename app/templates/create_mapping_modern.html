{% extends "base_simple.html" %}

{% block title %}Create Data Mapping - Data Integration Platform{% endblock %}

{% block extra_css %}
<style>
    /* Modern Color Palette */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #0cebeb 0%, #20e3b2 100%);
        --info-gradient: linear-gradient(135deg, #667eea 0%, #4facfe 100%);
        --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        --card-shadow: 0 10px 40px rgba(0,0,0,0.1);
        --card-hover-shadow: 0 15px 50px rgba(0,0,0,0.15);
    }

    /* Page Header */
    .page-header {
        background: var(--primary-gradient);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        color: white;
    }

    .page-header h1 {
        font-weight: 700;
        font-size: 2rem;
        margin: 0;
    }

    /* Modern Card Design */
    .modern-card {
        background: white;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        border: none;
        overflow: hidden;
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }

    .modern-card:hover {
        box-shadow: var(--card-hover-shadow);
        transform: translateY(-2px);
    }

    .modern-card-header {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 1.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    .modern-card-header h5 {
        font-weight: 600;
        margin: 0;
        color: #2d3748;
    }

    .modern-card-body {
        padding: 2rem;
    }

    /* Form Inputs */
    .form-control, .form-select {
        border-radius: 12px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-label {
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
    }

    /* Modern Buttons */
    .btn-modern {
        border-radius: 12px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        border: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .btn-modern-primary {
        background: var(--primary-gradient);
        color: white;
    }

    .btn-modern-success {
        background: var(--success-gradient);
        color: white;
    }

    .btn-modern-info {
        background: var(--info-gradient);
        color: white;
    }

    .btn-modern-secondary {
        background: linear-gradient(135deg, #868f96 0%, #596164 100%);
        color: white;
    }

    /* Field Mapping Section */
    .field-mapping-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 20px;
        padding: 2rem;
        min-height: 600px;
    }

    .field-panel {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        height: 550px;
        display: flex;
        flex-direction: column;
    }

    .field-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .field-panel-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .field-count-badge {
        background: var(--primary-gradient);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .field-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .field-list::-webkit-scrollbar {
        width: 8px;
    }

    .field-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .field-list::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
    }

    .field-list::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }

    /* Field Items - Ultra Modern Design */
    .field-item {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        cursor: move;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        overflow: hidden;
    }

    .field-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: var(--primary-gradient);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .field-item:hover {
        border-color: #667eea;
        transform: translateY(-4px) translateX(6px);
        box-shadow: 0 12px 24px rgba(102, 126, 234, 0.15);
    }

    .field-item:hover::before {
        opacity: 1;
    }

    .field-item.dragging {
        opacity: 0.6;
        transform: scale(0.98) rotate(2deg);
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
    }

    .field-item-name {
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.05rem;
    }

    .field-grip {
        color: #cbd5e0;
        font-size: 0.9rem;
        transition: color 0.3s ease;
    }

    .field-item:hover .field-grip {
        color: #667eea;
    }

    .field-item-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
    }

    .field-item-type {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.9rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .field-item-type i {
        font-size: 0.85rem;
    }

    .type-string {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .type-integer, .type-number {
        background: linear-gradient(135deg, #0cebeb 0%, #20e3b2 100%);
        color: white;
    }

    .type-date, .type-datetime {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .type-boolean {
        background: linear-gradient(135deg, #ffc371 0%, #ff5f6d 100%);
        color: white;
    }

    .type-object {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }

    .field-item-example {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #4a5568;
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        font-weight: 600;
        font-family: 'Courier New', monospace;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Drop Zone */
    .field-item.drop-zone {
        cursor: pointer;
        border-style: dashed;
    }

    .field-item.drop-zone::after {
        content: '\f0ab';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.5rem;
        color: #e9ecef;
        transition: all 0.3s ease;
    }

    .field-item.drop-zone:hover::after {
        color: #667eea;
        transform: translateY(-50%) scale(1.2);
    }

    .field-item.drop-zone.drag-over {
        border-color: #20e3b2;
        background: linear-gradient(135deg, #0cebeb20 0%, #20e3b230 100%);
        border-style: dashed;
        border-width: 3px;
        transform: scale(1.02);
        box-shadow: 0 0 30px rgba(32, 227, 178, 0.4);
    }

    .field-item.drop-zone.drag-over::after {
        content: '\f00c';
        color: #20e3b2;
        transform: translateY(-50%) scale(1.3) rotate(360deg);
    }

    /* Center Connection */
    .mapping-connector {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }

    .connector-icon {
        background: var(--primary-gradient);
        color: white;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }
    }

    .connector-text {
        margin-top: 1rem;
        color: #718096;
        font-weight: 600;
        text-align: center;
    }

    /* AI Suggestions Section */
    .ai-suggestions-panel {
        background: white;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        padding: 1.5rem;
        margin-top: 2rem;
        border-left: 5px solid;
        border-image: var(--info-gradient) 1;
        animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-suggestions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .ai-suggestions-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 700;
        font-size: 1.2rem;
        color: #2d3748;
    }

    .ai-icon {
        background: var(--info-gradient);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Mapping Rules Table - Ultra Modern */
    .mapping-rules-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        padding: 2rem;
        margin-top: 2rem;
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 1rem;
    }

    .modern-table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 700;
        padding: 1.25rem 1.5rem;
        text-align: left;
        border: none;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .modern-table thead th:first-child {
        border-radius: 15px 0 0 15px;
    }

    .modern-table thead th:last-child {
        border-radius: 0 15px 15px 0;
    }

    .modern-table tbody tr {
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
    }

    .modern-table tbody tr:hover {
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        transform: translateY(-3px);
        border-color: rgba(102, 126, 234, 0.3);
    }

    .modern-table tbody td {
        padding: 1.5rem 1.5rem;
        border: none;
        vertical-align: middle;
        background: white;
    }

    .modern-table tbody tr td:first-child {
        border-radius: 15px 0 0 15px;
    }

    .modern-table tbody tr td:last-child {
        border-radius: 0 15px 15px 0;
    }

    /* Field Code Badges - Premium Look */
    .field-code {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 0.6rem 1.2rem;
        border-radius: 12px;
        font-family: 'Courier New', monospace;
        font-weight: 700;
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .field-code::before {
        content: '\f1c0';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        opacity: 0.7;
    }

    .field-code.destination {
        background: linear-gradient(135deg, #0cebeb 0%, #20e3b2 100%);
        box-shadow: 0 4px 12px rgba(32, 227, 178, 0.3);
    }

    .field-code.destination::before {
        content: '\f1c0';
    }

    /* Transformation Select - Modern Dropdown */
    .transform-select {
        border-radius: 12px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        background: white;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        color: #2d3748;
        font-size: 0.9rem;
    }

    .transform-select:hover {
        border-color: #cbd5e0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .transform-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        outline: none;
    }

    /* Action Buttons in Table - Premium Design */
    .btn-action {
        padding: 0.7rem 1.2rem;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
    }

    .btn-action-delete {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
    }

    .btn-action-delete:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 20px rgba(245, 87, 108, 0.5);
    }

    .btn-action-delete:active {
        transform: translateY(0) scale(1);
    }

    /* Checkbox Styling */
    .modern-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #667eea;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #a0aec0;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .empty-state-text {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .empty-state-subtext {
        font-size: 0.9rem;
        color: #cbd5e0;
    }

    /* Save Section */
    .save-section {
        background: white;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        padding: 2rem;
        margin-top: 2rem;
        text-align: center;
    }

    .btn-save-large {
        background: var(--success-gradient);
        color: white;
        border: none;
        border-radius: 15px;
        padding: 1rem 3rem;
        font-size: 1.2rem;
        font-weight: 700;
        box-shadow: 0 10px 30px rgba(32, 227, 178, 0.3);
        transition: all 0.3s ease;
    }

    .btn-save-large:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(32, 227, 178, 0.5);
    }

    /* Loading Animation */
    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .field-panel {
            height: auto;
            min-height: 300px;
            margin-bottom: 1rem;
        }

        .connector-icon {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
    }

    /* Tooltip */
    .tooltip-modern {
        position: relative;
        display: inline-block;
    }

    .tooltip-modern .tooltiptext {
        visibility: hidden;
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        color: white;
        text-align: center;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .tooltip-modern:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-project-diagram"></i> Create Data Mapping</h1>
            <p class="mb-0 mt-2" style="opacity: 0.9;">Build intelligent field mappings between your data sources</p>
        </div>
        <a href="{{ url_for('mappings') }}" class="btn btn-modern btn-modern-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Mapping Configuration -->
<div class="modern-card">
    <div class="modern-card-header">
        <h5><i class="fas fa-cog"></i> Mapping Configuration</h5>
    </div>
    <div class="modern-card-body">
        <form id="mappingForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-4">
                        <label for="mappingName" class="form-label">
                            <i class="fas fa-tag"></i> Mapping Name *
                        </label>
                        <input type="text" class="form-control" id="mappingName"
                               placeholder="Enter a descriptive name..." required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-4">
                        <label for="mappingDescription" class="form-label">
                            <i class="fas fa-align-left"></i> Description
                        </label>
                        <input type="text" class="form-control" id="mappingDescription"
                               placeholder="Optional description...">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-4">
                        <label for="sourceSelect" class="form-label">
                            <i class="fas fa-database"></i> Source System *
                        </label>
                        <select class="form-select" id="sourceSelect" required>
                            <option value="">Select a source...</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-4">
                        <label for="destinationSelect" class="form-label">
                            <i class="fas fa-cloud-upload-alt"></i> Destination System *
                        </label>
                        <select class="form-select" id="destinationSelect" required>
                            <option value="">Select a destination...</option>
                        </select>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Field Mapping Section -->
<div id="fieldMappingSection" style="display:none;">
    <div class="modern-card">
        <div class="modern-card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-exchange-alt"></i> Field Mapping Workspace</h5>
                <div>
                    <button type="button" class="btn btn-modern btn-modern-primary btn-sm" id="aiMapFieldsBtn">
                        <i class="fas fa-magic"></i> AI Auto-Map
                    </button>
                </div>
            </div>
        </div>
        <div class="modern-card-body p-0">
            <div class="field-mapping-container">
                <div class="row">
                    <!-- Source Fields -->
                    <div class="col-md-5">
                        <div class="field-panel">
                            <div class="field-panel-header">
                                <div class="field-panel-title">
                                    <i class="fas fa-database"></i> Source Fields
                                </div>
                                <span class="field-count-badge" id="sourceFieldCount">0</span>
                            </div>
                            <div class="field-list" id="sourceFieldsList">
                                <div class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <div class="empty-state-text">Loading fields...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Indicator -->
                    <div class="col-md-2">
                        <div class="mapping-connector">
                            <div class="connector-icon">
                                <i class="fas fa-arrows-alt-h"></i>
                            </div>
                            <div class="connector-text">
                                Drag & Drop<br>to Map
                            </div>
                        </div>
                    </div>

                    <!-- Destination Fields -->
                    <div class="col-md-5">
                        <div class="field-panel">
                            <div class="field-panel-header">
                                <div class="field-panel-title">
                                    <i class="fas fa-cloud-upload-alt"></i> Destination Fields
                                </div>
                                <span class="field-count-badge" id="destFieldCount">0</span>
                            </div>
                            <div class="field-list" id="destinationFieldsList">
                                <div class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <div class="empty-state-text">Loading fields...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Suggestions Panel -->
    <div class="ai-suggestions-panel" id="aiSuggestionsSection" style="display:none;">
        <div class="ai-suggestions-header">
            <div class="ai-suggestions-title">
                <div class="ai-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <span>AI Mapping Suggestions</span>
                <span class="field-count-badge" id="suggestionCount">0</span>
            </div>
            <div>
                <button type="button" class="btn btn-modern btn-modern-success btn-sm me-2"
                        id="addSelectedSuggestionsBtn" onclick="handleAddSelectedClick()">
                    <i class="fas fa-check"></i> Add Selected
                </button>
                <button type="button" class="btn btn-modern btn-modern-info btn-sm"
                        id="addAllSuggestionsBtn">
                    <i class="fas fa-download"></i> Add All
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 5%">
                            <input type="checkbox" class="modern-checkbox" id="selectAllSuggestions" title="Select All">
                        </th>
                        <th style="width: 30%">Source Field</th>
                        <th style="width: 30%">Destination Field</th>
                        <th style="width: 20%">Transformation</th>
                        <th style="width: 15%">Confidence</th>
                    </tr>
                </thead>
                <tbody id="aiSuggestionsBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Mapping Rules -->
    <div class="mapping-rules-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-list-check"></i> Active Mapping Rules
                <span class="field-count-badge" id="mappingCount">0</span>
            </h5>
        </div>
        <div class="table-responsive">
            <table class="modern-table" id="mappingRulesTable">
                <thead>
                    <tr>
                        <th style="width: 35%">Source Field</th>
                        <th style="width: 35%">Destination Field</th>
                        <th style="width: 20%">Transformation</th>
                        <th style="width: 10%">Action</th>
                    </tr>
                </thead>
                <tbody id="mappingRulesBody">
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <i class="fas fa-map"></i>
                                <div class="empty-state-text">No mappings configured yet</div>
                                <div class="empty-state-subtext">Use AI Auto-Map or drag fields to create mappings</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Save Section -->
    <div class="save-section">
        <button type="button" class="btn btn-save-large" id="saveMappingBtnBottom">
            <i class="fas fa-save"></i> Save Mapping Configuration
        </button>
        <p class="mt-3 text-muted">
            <i class="fas fa-info-circle"></i> Make sure to review all mappings before saving
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sourceFields = [];
let destinationFields = [];
let fieldMappings = [];
let aiSuggestions = [];

$(document).ready(function() {
    loadSources();
    loadDestinations();

    // Watch for source/destination selection
    $('#sourceSelect, #destinationSelect').change(function() {
        const sourceId = $('#sourceSelect').val();
        const destId = $('#destinationSelect').val();

        if (sourceId && destId) {
            loadFieldsAndShowMapping(sourceId, destId);
        }
    });

    // AI Auto-Map button
    $('#aiMapFieldsBtn').click(function() {
        aiAutoMapFields();
    });

    // Select all suggestions checkbox
    $('#selectAllSuggestions').click(function() {
        $('.suggestion-checkbox').prop('checked', $(this).prop('checked'));
    });

    // Add All Suggestions button
    $('#addAllSuggestionsBtn').click(function() {
        if (aiSuggestions && aiSuggestions.length > 0) {
            aiSuggestions.forEach(function(suggestion) {
                if (suggestion && suggestion.source_field && suggestion.destination_field) {
                    addFieldMapping(
                        suggestion.source_field,
                        suggestion.destination_field,
                        suggestion.transformation || 'direct'
                    );
                }
            });
            showNotification('Added all ' + aiSuggestions.length + ' suggestions!', 'success');
            aiSuggestions = [];
            $('#aiSuggestionsSection').slideUp();
        }
    });

    // Save Mapping button (bottom)
    $('#saveMappingBtnBottom').click(function() {
        saveMapping();
    });
});

function loadSources() {
    $.get('/api/sources', function(data) {
        if (data.success) {
            const select = $('#sourceSelect');
            select.empty().append('<option value="">Select a source...</option>');
            data.data.forEach(function(source) {
                select.append('<option value="' + source.id + '">' + source.name + ' (' + source.type + ')</option>');
            });
        }
    });
}

function loadDestinations() {
    $.get('/api/destinations', function(data) {
        if (data.success) {
            const select = $('#destinationSelect');
            select.empty().append('<option value="">Select a destination...</option>');
            data.data.forEach(function(destination) {
                select.append('<option value="' + destination.id + '">' + destination.name + ' (' + destination.type + ')</option>');
            });
        }
    });
}

function loadFieldsAndShowMapping(sourceId, destId) {
    $('#fieldMappingSection').slideDown();

    // Load source schema
    $.get('/api/sources/' + sourceId + '/schema', function(data) {
        if (data.success) {
            sourceFields = data.data.fields || [];
            displaySourceFields();
        }
    }).fail(function() {
        $.get('/api/sources/' + sourceId, function(data) {
            if (data.success) {
                const schemaInfo = data.data.schema_info || {};
                sourceFields = schemaInfo.fields || [];
                if (sourceFields.length === 0) {
                    sourceFields = [
                        {name: 'id', type: 'integer', example: '12345'},
                        {name: 'name', type: 'string', example: 'John Doe'}
                    ];
                }
                displaySourceFields();
            }
        });
    });

    // Load destination schema
    $.get('/api/destinations/' + destId + '/schema', function(data) {
        if (data.success) {
            destinationFields = data.data.fields || [];
            displayDestinationFields();
        }
    }).fail(function() {
        $.get('/api/destinations/' + destId, function(data) {
            if (data.success) {
                const schemaInfo = data.data.schema_info || {};
                destinationFields = schemaInfo.fields || [];
                displayDestinationFields();
            }
        });
    });
}

function displaySourceFields() {
    let html = '';
    if (sourceFields.length === 0) {
        html = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><div class="empty-state-text">No fields found</div></div>';
    } else {
        sourceFields.forEach(function(field) {
            const typeClass = 'type-' + (field.type || 'string').toLowerCase();
            const typeIcon = getTypeIcon(field.type || 'string');

            html += '<div class="field-item" data-field-name="' + field.name + '" data-field-type="' + field.type + '" draggable="true">';
            html += '  <div class="field-item-name">';
            html += '    <i class="fas fa-grip-vertical field-grip"></i>';
            html += '    <span>' + field.name + '</span>';
            html += '  </div>';
            html += '  <div class="field-item-meta">';
            html += '    <span class="field-item-type ' + typeClass + '">';
            html += '      <i class="' + typeIcon + '"></i>';
            html += '      ' + (field.type || 'string');
            html += '    </span>';
            if (field.example) {
                html += '    <span class="field-item-example">' + field.example + '</span>';
            }
            html += '  </div>';
            html += '</div>';
        });
    }
    $('#sourceFieldsList').html(html);
    $('#sourceFieldCount').text(sourceFields.length);

    // Enable drag for source fields
    $('.field-item[draggable="true"]').on('dragstart', function(e) {
        $(this).addClass('dragging');
        e.originalEvent.dataTransfer.setData('fieldName', $(this).data('field-name'));
        e.originalEvent.dataTransfer.setData('fieldType', $(this).data('field-type'));
    }).on('dragend', function() {
        $(this).removeClass('dragging');
    });
}

function getTypeIcon(type) {
    const typeMap = {
        'string': 'fas fa-font',
        'integer': 'fas fa-hashtag',
        'number': 'fas fa-hashtag',
        'date': 'fas fa-calendar',
        'datetime': 'fas fa-calendar-alt',
        'boolean': 'fas fa-toggle-on',
        'object': 'fas fa-cube'
    };
    return typeMap[type.toLowerCase()] || 'fas fa-tag';
}

function displayDestinationFields() {
    let html = '';
    if (destinationFields.length === 0) {
        html = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><div class="empty-state-text">No fields found</div></div>';
    } else {
        destinationFields.forEach(function(field) {
            const typeClass = 'type-' + (field.type || 'string').toLowerCase();
            const typeIcon = getTypeIcon(field.type || 'string');

            html += '<div class="field-item drop-zone" data-field-name="' + field.name + '" data-field-type="' + field.type + '">';
            html += '  <div class="field-item-name">';
            html += '    <i class="fas fa-bullseye field-grip"></i>';
            html += '    <span>' + field.name + '</span>';
            html += '  </div>';
            html += '  <div class="field-item-meta">';
            html += '    <span class="field-item-type ' + typeClass + '">';
            html += '      <i class="' + typeIcon + '"></i>';
            html += '      ' + (field.type || 'string');
            html += '    </span>';
            if (field.example) {
                html += '    <span class="field-item-example">' + field.example + '</span>';
            }
            html += '  </div>';
            html += '</div>';
        });
    }
    $('#destinationFieldsList').html(html);
    $('#destFieldCount').text(destinationFields.length);

    // Enable drop for destination fields
    $('.drop-zone').on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('drag-over');
    }).on('dragleave', function() {
        $(this).removeClass('drag-over');
    }).on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');

        const sourceField = e.originalEvent.dataTransfer.getData('fieldName');
        const destField = $(this).data('field-name');

        addFieldMapping(sourceField, destField, 'direct');
        showNotification('‚úì Mapping: ' + sourceField + ' ‚Üí ' + destField, 'success');
    });
}

function addFieldMapping(sourceField, destField, transformation) {
    transformation = transformation || 'direct';

    // Check if mapping already exists
    const exists = fieldMappings.some(function(m) {
        return m.source === sourceField && m.destination === destField;
    });

    if (exists) {
        return;
    }

    fieldMappings.push({
        source: sourceField,
        destination: destField,
        transformation: transformation
    });

    renderMappingTable();
}

function removeMapping(index) {
    fieldMappings.splice(index, 1);
    renderMappingTable();
    showNotification('Mapping removed', 'info');
}

function renderMappingTable() {
    let html = '';

    if (fieldMappings.length === 0) {
        html = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-map"></i><div class="empty-state-text">No mappings configured yet</div><div class="empty-state-subtext">Use AI Auto-Map or drag fields to create mappings</div></div></td></tr>';
    } else {
        fieldMappings.forEach(function(mapping, index) {
            html += '<tr>';
            html += '  <td><span class="field-code">' + mapping.source + '</span></td>';
            html += '  <td><span class="field-code destination">' + mapping.destination + '</span></td>';
            html += '  <td>';
            html += '    <select class="form-select transform-select mapping-transformation" data-index="' + index + '">';
            html += '      <option value="direct"' + (mapping.transformation === 'direct' ? ' selected' : '') + '>‚úì Direct Copy</option>';
            html += '      <option value="uppercase"' + (mapping.transformation === 'uppercase' ? ' selected' : '') + '>‚Üë UPPERCASE</option>';
            html += '      <option value="lowercase"' + (mapping.transformation === 'lowercase' ? ' selected' : '') + '>‚Üì lowercase</option>';
            html += '      <option value="trim"' + (mapping.transformation === 'trim' ? ' selected' : '') + '>‚úÇ Trim Spaces</option>';
            html += '      <option value="number"' + (mapping.transformation === 'number' ? ' selected' : '') + '># To Number</option>';
            html += '      <option value="date"' + (mapping.transformation === 'date' ? ' selected' : '') + '>üìÖ To Date</option>';
            html += '      <option value="json"' + (mapping.transformation === 'json' ? ' selected' : '') + '>{ } Parse JSON</option>';
            html += '    </select>';
            html += '  </td>';
            html += '  <td class="text-center">';
            html += '    <button class="btn-action btn-action-delete" onclick="removeMapping(' + index + ')" title="Remove mapping">';
            html += '      <i class="fas fa-trash-alt"></i> Delete';
            html += '    </button>';
            html += '  </td>';
            html += '</tr>';
        });
    }

    $('#mappingRulesBody').html(html);
    $('#mappingCount').text(fieldMappings.length);

    // Handle transformation changes with feedback
    $('.mapping-transformation').change(function() {
        const index = $(this).data('index');
        const newTransform = $(this).val();
        fieldMappings[index].transformation = newTransform;
        showNotification('Transformation updated to: ' + newTransform, 'info');
    });
}

function handleAddSelectedClick() {
    addSelectedSuggestions();
}

function addSelectedSuggestions() {
    let addedCount = 0;

    $('.suggestion-checkbox:checked').each(function() {
        const index = $(this).data('index');
        const suggestion = aiSuggestions[index];

        if (suggestion) {
            addFieldMapping(
                suggestion.source_field,
                suggestion.destination_field,
                suggestion.transformation
            );
            addedCount++;
        }
    });

    if (addedCount > 0) {
        showNotification('Added ' + addedCount + ' mapping(s) from AI suggestions', 'success');
        aiSuggestions = [];
        $('#aiSuggestionsSection').slideUp();
    } else {
        showNotification('Please select at least one suggestion', 'warning');
    }
}

function aiAutoMapFields() {
    if (sourceFields.length === 0 || destinationFields.length === 0) {
        showNotification('Please ensure both source and destination have fields loaded', 'warning');
        return;
    }

    const btn = $('#aiMapFieldsBtn');
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Analyzing...');

    $.ajax({
        url: '/api/ai/suggest-mappings',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            source_schema: sourceFields,
            destination_schema: destinationFields
        }),
        success: function(data) {
            if (data.success && data.suggestions) {
                try {
                    let suggestions = data.suggestions;

                    if (typeof suggestions === 'string' || suggestions.raw_content) {
                        const content = suggestions.raw_content || suggestions;
                        const jsonMatch = content.match(/\{[\s\S]*"mappings"[\s\S]*\}/);

                        if (jsonMatch) {
                            suggestions = JSON.parse(jsonMatch[0]);
                        }
                    }

                    if (suggestions.mappings && Array.isArray(suggestions.mappings)) {
                        aiSuggestions = suggestions.mappings.map(function(mapping) {
                            return {
                                source_field: mapping.source_field,
                                destination_field: mapping.destination_field,
                                transformation: mapping.transformation || 'direct',
                                confidence: mapping.confidence || 'high'
                            };
                        });

                        displayAISuggestions();
                        showNotification('AI suggested ' + aiSuggestions.length + ' mappings. Review and select.', 'info');
                    } else {
                        showNotification('AI provided suggestions in unexpected format', 'warning');
                    }
                } catch (e) {
                    showNotification('Could not parse AI suggestions', 'error');
                }
            } else {
                showNotification('AI mapping failed: ' + (data.error || 'Unknown error'), 'error');
            }

            btn.prop('disabled', false).html('<i class="fas fa-magic"></i> AI Auto-Map');
        },
        error: function() {
            showNotification('Failed to connect to AI service', 'error');
            btn.prop('disabled', false).html('<i class="fas fa-magic"></i> AI Auto-Map');
        }
    });
}

function displayAISuggestions() {
    if (aiSuggestions.length === 0) {
        $('#aiSuggestionsSection').hide();
        return;
    }

    let html = '';
    aiSuggestions.forEach(function(suggestion, index) {
        const confidenceIcons = {
            'high': '‚≠ê‚≠ê‚≠ê',
            'medium': '‚≠ê‚≠ê',
            'low': '‚≠ê'
        };
        const confidenceClass = suggestion.confidence === 'high' ? 'success' :
                                (suggestion.confidence === 'medium' ? 'warning' : 'secondary');
        const confidenceIcon = confidenceIcons[suggestion.confidence] || '‚≠ê';

        html += '<tr>';
        html += '  <td class="text-center">';
        html += '    <input type="checkbox" class="modern-checkbox suggestion-checkbox" data-index="' + index + '" checked>';
        html += '  </td>';
        html += '  <td><span class="field-code">' + suggestion.source_field + '</span></td>';
        html += '  <td><span class="field-code destination">' + suggestion.destination_field + '</span></td>';
        html += '  <td>';
        html += '    <span style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 600;">';
        html += (suggestion.transformation || 'direct');
        html += '    </span>';
        html += '  </td>';
        html += '  <td>';
        html += '    <span class="badge bg-' + confidenceClass + '" style="padding: 0.5rem 1rem; font-size: 0.85rem;">';
        html += confidenceIcon + ' ' + (suggestion.confidence || 'high').toUpperCase();
        html += '    </span>';
        html += '  </td>';
        html += '</tr>';
    });

    $('#aiSuggestionsBody').html(html);
    $('#suggestionCount').text(aiSuggestions.length);
    $('#aiSuggestionsSection').slideDown();
}

function saveMapping() {
    const mappingData = {
        name: $('#mappingName').val(),
        description: $('#mappingDescription').val(),
        source_id: $('#sourceSelect').val(),
        destination_id: $('#destinationSelect').val(),
        field_mappings: []
    };

    if (!mappingData.name || !mappingData.source_id || !mappingData.destination_id) {
        showNotification('Please fill in all required fields', 'warning');
        return;
    }

    if (fieldMappings && fieldMappings.length > 0) {
        mappingData.field_mappings = fieldMappings.map(function(m) {
            return {
                source_field: m.source,
                destination_field: m.destination,
                transformation: m.transformation || 'direct'
            };
        });
    }

    if (mappingData.field_mappings.length === 0) {
        showNotification('Please add at least one field mapping', 'warning');
        return;
    }

    const btn = $('#saveMappingBtnBottom');
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

    $.ajax({
        url: '/api/mappings',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(mappingData),
        success: function(data) {
            if (data.success) {
                showNotification('Mapping saved successfully!', 'success');
                setTimeout(function() {
                    window.location.href = '{{ url_for("mappings") }}';
                }, 1500);
            } else {
                showNotification('Failed to save mapping: ' + data.error, 'error');
                btn.prop('disabled', false).html('<i class="fas fa-save"></i> Save Mapping Configuration');
            }
        },
        error: function() {
            showNotification('Failed to save mapping', 'error');
            btn.prop('disabled', false).html('<i class="fas fa-save"></i> Save Mapping Configuration');
        }
    });
}

function showNotification(message, type) {
    const bgColor = type === 'success' ? 'linear-gradient(135deg, #0cebeb 0%, #20e3b2 100%)' :
                     type === 'error' ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' :
                     type === 'warning' ? 'linear-gradient(135deg, #ffc371 0%, #ff5f6d 100%)' :
                     'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

    const notification = $('<div>')
        .css({
            position: 'fixed',
            top: '20px',
            right: '20px',
            background: bgColor,
            color: 'white',
            padding: '1rem 1.5rem',
            borderRadius: '12px',
            boxShadow: '0 10px 30px rgba(0,0,0,0.3)',
            zIndex: 9999,
            fontWeight: '600',
            animation: 'slideIn 0.3s ease'
        })
        .text(message);

    $('body').append(notification);

    setTimeout(function() {
        notification.fadeOut(function() {
            $(this).remove();
        });
    }, 3000);
}
</script>
{% endblock %}
