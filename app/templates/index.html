{% extends "base.html" %}

{% block title %}Dashboard - Data Integration Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Sources</h5>
                        <h2 id="sources-count">-</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Destinations</h5>
                        <h2 id="destinations-count">-</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-cloud-upload-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Mappings</h5>
                        <h2 id="mappings-count">-</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-map fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Active Jobs</h5>
                        <h2 id="jobs-count">-</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tasks fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('main.sources') }}" class="btn btn-outline-primary btn-lg w-100">
                            <i class="fas fa-plus"></i><br>
                            Add Source
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('main.destinations') }}" class="btn btn-outline-success btn-lg w-100">
                            <i class="fas fa-plus"></i><br>
                            Add Destination
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('main.create_mapping') }}" class="btn btn-outline-info btn-lg w-100">
                            <i class="fas fa-map"></i><br>
                            Create Mapping
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('main.jobs') }}" class="btn btn-outline-warning btn-lg w-100">
                            <i class="fas fa-play"></i><br>
                            Start Job
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock"></i> Recent Jobs
                </h5>
            </div>
            <div class="card-body">
                <div id="recent-jobs">
                    <p class="text-muted">Loading recent jobs...</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line"></i> System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>System Health</span>
                        <span class="badge bg-success">Healthy</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Active Connections</span>
                        <span id="active-connections">-</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Processing Queue</span>
                        <span id="queue-size">-</span>
                    </div>
                </div>
                <div>
                    <div class="d-flex justify-content-between">
                        <span>Uptime</span>
                        <span id="uptime">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Load dashboard data
    loadDashboardData();
    
    // Refresh data every 30 seconds
    setInterval(loadDashboardData, 30000);
});

function loadDashboardData() {
    // Load counts
    $.get('/api/sources', function(data) {
        if (data.success) {
            $('#sources-count').text(data.data.length);
        }
    });
    
    $.get('/api/destinations', function(data) {
        if (data.success) {
            $('#destinations-count').text(data.data.length);
        }
    });
    
    $.get('/api/mappings', function(data) {
        if (data.success) {
            $('#mappings-count').text(data.data.length);
        }
    });
    
    $.get('/api/jobs', function(data) {
        if (data.success) {
            const activeJobs = data.data.filter(job => job.status === 'running' || job.status === 'pending');
            $('#jobs-count').text(activeJobs.length);
            
            // Display recent jobs
            displayRecentJobs(data.data.slice(0, 5));
        }
    });
    
    // Update system status
    $('#active-connections').text('2');
    $('#queue-size').text('0');
    $('#uptime').text('2h 15m');
}

function displayRecentJobs(jobs) {
    if (jobs.length === 0) {
        $('#recent-jobs').html('<p class="text-muted">No recent jobs found.</p>');
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    jobs.forEach(function(job) {
        const statusClass = getStatusClass(job.status);
        const timeAgo = formatTimeAgo(job.created_at);
        
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${job.name}</h6>
                    <small class="text-muted">${timeAgo}</small>
                </div>
                <span class="badge ${statusClass}">${job.status}</span>
            </div>
        `;
    });
    html += '</div>';
    
    $('#recent-jobs').html(html);
}

function getStatusClass(status) {
    switch(status) {
        case 'completed': return 'bg-success';
        case 'running': return 'bg-primary';
        case 'failed': return 'bg-danger';
        case 'pending': return 'bg-warning';
        default: return 'bg-secondary';
    }
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInMinutes = Math.floor((now - date) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
    return `${Math.floor(diffInMinutes / 1440)}d ago`;
}
</script>
{% endblock %}